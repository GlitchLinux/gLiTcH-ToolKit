#!/bin/bash

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" >&2
    exit 1
fi

# Configuration
REFIND_VERSION="0.14.2"
DOWNLOAD_URL="https://sourceforge.net/projects/refind/files/${REFIND_VERSION}/refind-cd-${REFIND_VERSION}.zip/download"
TEMP_DIR="/tmp/refind-install"
ISO_FILE="refind-cd-${REFIND_VERSION}.iso"
GRUB_ENTRY_FILE="/etc/grub.d/40_refind"
BOOT_DIR="/boot/refind"

# Create temp directory
mkdir -p "$TEMP_DIR"
cd "$TEMP_DIR" || exit

# Download rEFInd
echo "Downloading rEFInd ${REFIND_VERSION}..."
wget -O "refind-cd-${REFIND_VERSION}.zip" "$DOWNLOAD_URL" || {
    echo "Failed to download rEFInd" >&2
    exit 1
}

# Extract the zip and ISO
echo "Extracting files..."
unzip "refind-cd-${REFIND_VERSION}.zip" || {
    echo "Failed to extract zip file" >&2
    exit 1
}

# Check if ISO exists
if [ ! -f "$ISO_FILE" ]; then
    echo "ISO file not found after extraction" >&2
    exit 1
fi

# Create boot directory
mkdir -p "$BOOT_DIR"

# Mount the ISO to copy EFI files
echo "Mounting ISO to copy EFI files..."
MOUNT_POINT=$(mktemp -d)
mount -o loop "$ISO_FILE" "$MOUNT_POINT" || {
    echo "Failed to mount ISO" >&2
    exit 1
}

# Copy EFI files
echo "Copying EFI files..."
cp -r "$MOUNT_POINT/EFI" "$BOOT_DIR" || {
    echo "Failed to copy EFI files" >&2
    umount "$MOUNT_POINT"
    exit 1
}

# Unmount ISO
umount "$MOUNT_POINT"
rmdir "$MOUNT_POINT"

# Create GRUB custom entry with "rEFInd (UEFI)" label
echo "Creating GRUB custom entry..."
cat > "$GRUB_ENTRY_FILE" <<EOF
#!/bin/sh
exec tail -n +3 \$0
# This file provides an easy way to add custom menu entries.  Simply type the
# menu entries you want to add after this comment.  Be careful not to change
# the 'exec tail' line above.

menuentry "rEFInd (UEFI)" {
    search --file --no-floppy --set=root /refind/EFI/boot/bootx64.efi
    chainloader /refind/EFI/boot/bootx64.efi
}
EOF

# Make the grub entry executable
chmod a+x "$GRUB_ENTRY_FILE"

# Update GRUB
echo "Updating GRUB..."
if command -v update-grub >/dev/null 2>&1; then
    update-grub
else
    grub-mkconfig -o /boot/grub/grub.cfg
fi

echo "rEFInd installation complete!"
echo "You should see a 'rEFInd (UEFI)' option in your GRUB menu on next boot."
echo "The rEFInd files have been installed to $BOOT_DIR"

# Clean up
rm -rf "$TEMP_DIR"
