#!/bin/bash

# Color codes
RED='\033[0;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;35m'
BLUE='\033[1;35m'
NC='\033[0m'

#---------------#
# Rapid IPXE VM #
#---------------#
IMG_URL="https://github.com/GlitchLinux/IPXE-MultiBoot/raw/refs/heads/main/GLITCH-IPXE.iso"
IMG_DIR="/tmp/ipxe"
IMG_PATH="$IMG_DIR/GLITCH-IPXE.iso"

#-------#
# Setup #
#-------#
mkdir -p "$IMG_DIR"
echo ""
#echo -e "\n[*] Downloading iPXE IMG to $IMG_PATH..."
curl -L --silent --show-error "$IMG_URL" -o "$IMG_PATH" || {
    echo "[!] Download failed!"
    exit 1
}

#-----------
# Main Loop
#---------------------------------------
while true; do
    echo ""
    echo -e "${GREEN}╭────────────────────────╮${NC}"
    echo -e "${GREEN}│${NC} Rapid IPXE VM LAUNCHER ${GREEN}│${NC}" 
    echo -e "${GREEN}╰────────────────────────╯${NC}"
    # Boot Mode Selection
    echo -e "\nChoose Boot Mode:"
    echo ""
    echo "1) BIOS"
    echo "2) UEFI"
    echo ""
    read -rp "Enter 1 or 2: " BOOT_MODE

    if [[ "$BOOT_MODE" != "1" && "$BOOT_MODE" != "2" ]]; then
        echo "[!] Invalid option. Please enter 1 or 2."
        continue
    fi

    # RAM Configuration
    read -rp "Enter to use 4G RAM or input new value (e.g., 2G, 8G): " RAM_SIZE
    RAM_SIZE=${RAM_SIZE:-4G}

    # Extra Disk Option
    read -rp "Add disk to VM? Enter for no, Y to add: " ADD_DISK
    EXTRA_DISK=""

    if [[ "$ADD_DISK" =~ ^[Yy]$ ]]; then
        echo -e "\nAvailable Disks:"
        lsblk
        echo
        fdisk -l 2>/dev/null | grep '^Disk /dev/' || true

        read -rp "Enter full device path (e.g., /dev/sdx): " DISK_PATH
        if [[ ! -b "$DISK_PATH" ]]; then
            echo "[!] Invalid disk path. Skipping extra disk."
        else
            EXTRA_DISK="-drive file=$DISK_PATH,format=raw"
        fi
    fi

    #----------------#
    # Launch QEMU VM #
    #----------------#
    echo ""
    echo -e "\n[*] Launching QEMU VM..."
    echo -e "[*] SSH will be forwarded to localhost:2222 (use: ssh -p 2222 user@localhost)\n"

    if [[ "$BOOT_MODE" == "1" ]]; then
        # BIOS Boot
        qemu-system-x86_64 \
            -enable-kvm \
            -m "$RAM_SIZE" \
            -drive file="$IMG_PATH",format=raw \
            $EXTRA_DISK \
            -boot order=d \
            -nic user,hostfwd=tcp::2222-:22 \
            > /dev/null 2>&1 &
    else
        # UEFI Boot
        if [[ ! -f /usr/share/OVMF/OVMF_CODE.fd && ! -f /usr/share/OVMF/OVMF_CODE.bin ]]; then
            echo "[!] UEFI firmware not found. Install 'ovmf' package."
            exit 1
        fi

        OVMF_PATH="/usr/share/OVMF/OVMF_CODE.fd"
        [[ -f "$OVMF_PATH" ]] || OVMF_PATH="/usr/share/OVMF/OVMF_CODE.bin"

        qemu-system-x86_64 \
            -enable-kvm \
            -m "$RAM_SIZE" \
            -bios "$OVMF_PATH" \
            -drive file="$IMG_PATH",format=raw \
            $EXTRA_DISK \
            -boot order=d \
            -nic user,hostfwd=tcp::2222-:22 \
            > /dev/null 2>&1 &
    fi

    disown

    echo -e "\n[*] Waiting for VM to shut down. Press ENTER when VM is closed to continue..."
    read -rp ""

    echo
    read -rp "Boot another VM? (y/n): " AGAIN
    [[ "$AGAIN" != "y" && "$AGAIN" != "Y" ]] && break
done

#---------#
# See ya! #
#---------#
echo ""
echo -e "\n[*] All done. Exiting.\n"
