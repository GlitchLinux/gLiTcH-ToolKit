#!/bin/bash
# Script to download KDE ISO, mount ISO, mount SquashFS, and copy KDE themes/configs

set -e

ISO_URL="https://glitchlinux.wtf/gLiTcH-Linux-KDE-v13.iso"
ISO_PATH="/tmp/gLiTcH-Linux-KDE-v13.iso"
ISO_MOUNT="/tmp/iso_mount"
SQUASHFS_MOUNT="/tmp/squashfs_mount"

echo "1. Downloading ISO..."
if [ ! -f "$ISO_PATH" ]; then
    wget -O "$ISO_PATH" "$ISO_URL"
else
    echo "ISO already exists at $ISO_PATH"
fi

echo "2. Creating mount points..."
mkdir -p "$ISO_MOUNT" "$SQUASHFS_MOUNT"

echo "3. Mounting ISO..."
sudo mount -o loop "$ISO_PATH" "$ISO_MOUNT"

# Find squashfs image inside ISO (usually in live/)
SQUASHFS_FILE=$(find "$ISO_MOUNT" -name "*.squashfs" | head -n 1)

if [ -z "$SQUASHFS_FILE" ]; then
    echo "Error: SquashFS file not found inside ISO."
    sudo umount "$ISO_MOUNT"
    exit 1
fi

echo "4. Mounting SquashFS file: $SQUASHFS_FILE"
sudo mount -t squashfs -o loop "$SQUASHFS_FILE" "$SQUASHFS_MOUNT"

echo "5. Copying KDE theme settings..."

# Copy system-wide Plasma themes
echo "Copying Plasma desktop themes..."
sudo cp -r "$SQUASHFS_MOUNT/usr/share/plasma/desktoptheme/"* /usr/share/plasma/desktoptheme/

echo "Copying Plasma global themes (look-and-feel)..."
sudo cp -r "$SQUASHFS_MOUNT/usr/share/plasma/look-and-feel/"* /usr/share/plasma/look-and-feel/

echo "Copying icons..."
sudo cp -r "$SQUASHFS_MOUNT/usr/share/icons/"* /usr/share/icons/

# Optionally copy user config files if available in /etc/skel
if [ -d "$SQUASHFS_MOUNT/etc/skel/.config" ]; then
    echo "Copying user config files to $HOME/.config/"
    mkdir -p "$HOME/.config"
    cp -r "$SQUASHFS_MOUNT/etc/skel/.config/"* "$HOME/.config/"
fi

if [ -d "$SQUASHFS_MOUNT/etc/skel/.local/share" ]; then
    echo "Copying user local share files to $HOME/.local/share/"
    mkdir -p "$HOME/.local/share"
    cp -r "$SQUASHFS_MOUNT/etc/skel/.local/share/"* "$HOME/.local/share/"
fi

if [ -d "$SQUASHFS_MOUNT/etc/skel/.icons" ]; then
    echo "Copying user icons to $HOME/.icons/"
    mkdir -p "$HOME/.icons"
    cp -r "$SQUASHFS_MOUNT/etc/skel/.icons/"* "$HOME/.icons/"
fi

echo "6. Cleanup: unmounting..."

sudo umount "$SQUASHFS_MOUNT"
sudo umount "$ISO_MOUNT"

rm -rf "$ISO_MOUNT" "$SQUASHFS_MOUNT"

echo "Done. Please restart Plasma session or run 'kbuildsycoca5' and 'plasmashell --replace' to apply changes."
