#!/bin/bash

# Script to fix systemd service failures in minimal Debian live system
# Run this in your container/chroot before creating the squashfs

#set -e

echo "=== Fixing Systemd Service Boot Issues ==="

# Update package lists
echo "Step 1: Updating package lists..."
apt update

# Install missing essential services and dependencies
echo "Step 2: Installing missing service dependencies..."
apt install -y \
    dbus \
    dbus-user-session \
    systemd \
    systemd-timesyncd \
    polkitd \
    network-manager \
    avahi-daemon \
    udisks2 \
    libpam-systemd \
    squashfs-tools \
    initramfs-tools \
    live-boot \
    systemd \
    udev \
    kmod \
    busybox \
    util-linux \
    mount \
    e2fsprogs \
    dosfstools \
    firmware-linux-free \
    wireless-tools \
    net-tools \
    iproute2 \
    dhcpcd5 \
    linux-image-amd64 \
    console-setup \
    keyboard-configuration \
    locales \
    systemd-resolved \
    live-tools \
    sudo \
    nano \
    less \
    bash-completion \
    ca-certificates \
    curl \
    wget

apt install -y ifupdown iproute2 dhcpcd5 -y

systemctl enable dbus
systemctl enable dbus-user-session

# Enable networking service (handles /etc/network/interfaces)
systemctl enable networking

# Enable systemd-networkd (alternative network manager)
systemctl enable systemd-networkd

# Enable systemd-resolved for DNS resolution
systemctl enable systemd-resolved

# If using dhcpcd5
systemctl enable dhcpcd

# OR if using ISC dhclient (choose one)
systemctl enable isc-dhcp-client
